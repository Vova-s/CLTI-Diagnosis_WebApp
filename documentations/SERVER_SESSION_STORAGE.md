# Server-Side Session Storage - –ó–∞–º—ñ–Ω–∞ LocalStorage

## üéØ –ü—Ä–æ–±–ª–µ–º–∞, —è–∫—É –≤–∏—Ä—ñ—à—É—î–º–æ

**–õ–æ–∫–∞–ª—å–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è (LocalStorage)** –º–∞—î –ø—Ä–æ–±–ª–µ–º–∏ –±–µ–∑–ø–µ–∫–∏:
- ‚ùå –î–æ—Å—Ç—É–ø–Ω–µ —á–µ—Ä–µ–∑ JavaScript (XSS –∞—Ç–∞–∫–∏)
- ‚ùå –ù–µ –ø—Ä–∞—Ü—é—î —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–ª–æ–∫—É—î cookies
- ‚ùå –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ (–º–æ–∂–Ω–∞ –∫—Ä–∞—Å—Ç–∏, –º–æ–¥–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏)

**–†—ñ—à–µ–Ω–Ω—è: Server-Side Session Storage**
- ‚úÖ –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ (–±–µ–∑–ø–µ—á–Ω—ñ—à–µ)
- ‚úÖ –ü—Ä–∞—Ü—é—î –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ cookies –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ (—á–µ—Ä–µ–∑ headers)
- ‚úÖ –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ñ –¥–ª—è JavaScript (–∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ XSS)

## üìã –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î

### 1. –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

```
Client (Browser)                    Server (IIS)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ             ‚îÇ                    ‚îÇ              ‚îÇ
‚îÇ Login       ‚îÇ‚îÄ‚îÄ‚îÄ POST /api/login ‚îÄ‚îÄ>‚îÇ AuthController‚îÇ
‚îÇ             ‚îÇ                    ‚îÇ              ‚îÇ
‚îÇ             ‚îÇ<‚îÄ‚îÄ Session ID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ Save tokens ‚îÇ
‚îÇ             ‚îÇ    (in header)     ‚îÇ in DB Cache ‚îÇ
‚îÇ             ‚îÇ                    ‚îÇ              ‚îÇ
‚îÇ API calls  ‚îÇ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ Read from   ‚îÇ
‚îÇ             ‚îÇ    X-Session-Id     ‚îÇ Session     ‚îÇ
‚îÇ             ‚îÇ                    ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. –ú–µ—Ö–∞–Ω—ñ–∑–º —Ä–æ–±–æ—Ç–∏

**Development (In-Memory Cache):**
- ‚úÖ –®–≤–∏–¥–∫–æ
- ‚ùå –í—Ç—Ä–∞—á–∞—î—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞

**Production (SQL Server Distributed Cache):**
- ‚úÖ –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
- ‚úÖ –ü–µ—Ä–µ–∂–∏–≤–∞—î –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –ü—Ä–∞—Ü—é—î –≤ –∫–ª–∞—Å—Ç–µ—Ä—ñ (–∫–æ–ª–∏—â–Ω–æ –∫—ñ–ª—å–∫–∞ —Å–µ—Ä–≤–µ—Ä—ñ–≤)

### 3. –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Å–µ—Å—ñ—ó

**–°–ø—Ä–æ–±—É—î –≤ —Ç–∞–∫–æ–º—É –ø–æ—Ä—è–¥–∫—É:**
1. Cookie `.AspNetCore.Session` (—è–∫—â–æ cookies –¥–æ–∑–≤–æ–ª–µ–Ω—ñ)
2. Header `X-Session-Id` (—è–∫—â–æ cookies –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ)
3. –ì–µ–Ω–µ—Ä—É—î –Ω–æ–≤–∏–π ID (—è–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ)

## üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è IIS

### –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é –¥–ª—è Cache (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)

–ü—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É –Ω–∞ Production, .NET –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—é `SessionCache` –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö.

**–ê–ë–û —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤—Ä—É—á–Ω—É:**

```sql
-- –ó–∞–ø—É—Å—Ç—ñ—Ç—å –≤ SQL Server Management Studio
CREATE TABLE [dbo].[SessionCache] (
    [Id] NVARCHAR(449) NOT NULL,
    [Value] VARBINARY(MAX) NOT NULL,
    [ExpiresAtTime] DATETIME2 NOT NULL,
    [SlidingExpirationInSeconds] BIGINT NULL,
    [AbsoluteExpiration] DATETIME2 NULL,
    CONSTRAINT [PK_SessionCache] PRIMARY KEY ([Id])
);

CREATE INDEX [IX_SessionCache_ExpiresAtTime] ON [dbo].[SessionCache]([ExpiresAtTime]);
```

### –ö—Ä–æ–∫ 2: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è IIS

1. **–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ Application Pool –º–∞—î –ø—Ä–∞–≤–∞ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–∏—Ö**

2. **–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Session State Provider (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)**

–£ `appsettings.Production.json` –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏:
```json
{
  "DistributedCache": {
    "ConnectionString": "Server=...;Database=...;...",
    "SchemaName": "dbo",
    "TableName": "SessionCache"
  }
}
```

### –ö—Ä–æ–∫ 3: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–±–æ—Ç–∏

–ü—ñ—Å–ª—è –¥–µ–ø–ª–æ—é –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:
1. –í–∏–∫–æ–Ω–∞–π—Ç–µ login
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –∑'—è–≤–∏–ª–∞—Å—è —Ç–∞–±–ª–∏—Ü—è `SessionCache`
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ - –º–∞—î –±—É—Ç–∏ "Token stored in server session"

## üîê –ë–µ–∑–ø–µ–∫–∞

### –ü–µ—Ä–µ–≤–∞–≥–∏:
- ‚úÖ –¢–æ–∫–µ–Ω–∏ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ
- ‚úÖ –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ JavaScript (XSS protection)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è expiry
- ‚úÖ –ü—Ä–∞—Ü—é—î –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ cookies –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏:
- HttpOnly cookies (—è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω—ñ)
- Secure cookies (–≤ HTTPS)
- SameSite=Lax (CSRF protection)
- Session timeout: 30 —Ö–≤–∏–ª–∏–Ω –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ

## üìù –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –∫–æ–¥—ñ

### Server-side (AuthController):
```csharp
// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤
await _sessionStorage.SetTokenAsync(token, rememberMe);
await _sessionStorage.SetRefreshTokenAsync(refreshToken, rememberMe);
await _sessionStorage.SetUserAsync(userDto);

// –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤
var token = await _sessionStorage.GetTokenAsync();
var user = await _sessionStorage.GetUserAsync<UserDto>();
```

### Client-side (Blazor):
–¢–æ–∫–µ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä, –∫–ª—ñ—î–Ω—Ç –Ω–µ –º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –Ω–∏—Ö –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ.

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ

1. **–°–µ—Å—ñ—è –º–∞—î –±—É—Ç–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–∞ –ø–µ—Ä–µ–¥ Authentication middleware**
   ```csharp
   app.UseSession(); // –ü–µ—Ä—à–∏–º
   app.UseAuthentication();
   ```

2. **–î–ª—è Production –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ SQL Server Cache** (–Ω–µ In-Memory)

3. **Session timeout**: –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 30 —Ö–≤–∏–ª–∏–Ω, –º–æ–∂–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –≤ `AddSession()`**

4. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥**: –°—Ç–µ–∂—Ç–µ –∑–∞ —Ä–æ–∑–º—ñ—Ä–æ–º —Ç–∞–±–ª–∏—Ü—ñ `SessionCache`, —Ä–æ–±—ñ—Ç—å cleanup —Å—Ç–∞—Ä–∏—Ö –∑–∞–ø–∏—Å—ñ–≤

## üöÄ –î–µ–ø–ª–æ–π –Ω–∞ IIS

1. –û–ø—É–±–ª—ñ–∫—É–π—Ç–µ –¥–æ–¥–∞—Ç–æ–∫
2. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è —â–æ connection string –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ Application Pool –º–∞—î –ø—Ä–∞–≤–∞ –Ω–∞ –ë–î
4. –°—Ç–≤–æ—Ä—ñ—Ç—å —Ç–∞–±–ª–∏—Ü—é SessionCache (–∑–∞–ø—É—Å—Ç—ñ—Ç—å `Scripts/CreateSessionCacheTable.sql`)

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ: –°–µ—Å—ñ—ó –ø—ñ—Å–ª—è —Ä–µ—Å—Ç–∞—Ä—Ç—É —Å–µ—Ä–≤–µ—Ä–∞

### –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:

1. **Data Protection Keys** –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ `Keys/` –ø–∞–ø—Ü—ñ - **–Ω–µ –≤–∏–¥–∞–ª—è–π—Ç–µ —ó—Ö!**
2. **Session Cache** –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ SQL Server - –¥–∞–Ω—ñ **–ø–µ—Ä–µ–∂–∏–≤–∞—é—Ç—å —Ä–µ—Å—Ç–∞—Ä—Ç**
3. **Session Cookie** –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ Data Protection –∫–ª—é—á–∞–º–∏ - –ø—Ä–∞—Ü—é—î —è–∫—â–æ –∫–ª—é—á—ñ –Ω–µ –∑–º—ñ–Ω–∏–ª–∏—Å—è

### –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –≤—Ç—Ä–∞—á–∞—é—Ç—å —Å–µ—Å—ñ—é –ø—ñ—Å–ª—è —Ä–µ—Å—Ç–∞—Ä—Ç—É:

**–ü—Ä–∏—á–∏–Ω–∞**: Data Protection –∫–ª—é—á—ñ –∑–º—ñ–Ω–∏–ª–∏—Å—è –∞–±–æ –±—É–ª–∏ –≤–∏–¥–∞–ª–µ–Ω—ñ.

**–†—ñ—à–µ–Ω–Ω—è**:
1. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è —â–æ –ø–∞–ø–∫–∞ `Keys/` —ñ—Å–Ω—É—î —ñ –Ω–µ –≤–∏–¥–∞–ª—è—î—Ç—å—Å—è
2. –î–æ–¥–∞–π—Ç–µ `Keys/` –¥–æ `.gitignore` (–Ω–µ –∫–æ–º—ñ—Ç—å—Ç–µ –∫–ª—é—á—ñ!)
3. –£ production: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Azure Key Vault –∞–±–æ shared key storage –¥–ª—è –∫—ñ–ª—å–∫–æ—Ö —Å–µ—Ä–≤–µ—Ä—ñ–≤

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è production –∑ –∫—ñ–ª—å–∫–æ–º–∞ —Å–µ—Ä–≤–µ—Ä–∞–º–∏:

```csharp
// –£ production –¥–ª—è –∫—ñ–ª—å–∫–æ—Ö —Å–µ—Ä–≤–µ—Ä—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ shared key storage
builder.Services.AddDataProtection()
    .PersistKeysToAzureBlobStorage(...) // –ê–±–æ —ñ–Ω—à–µ shared —Å—Ö–æ–≤–∏—â–µ
    .SetApplicationName("CLTI.Diagnosis")
    .SetDefaultKeyLifetime(TimeSpan.FromDays(90));
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –±–µ–∑–ø–µ—á–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ, **—Å–µ—Å—ñ—ó –ø–µ—Ä–µ–∂–∏–≤–∞—é—Ç—å —Ä–µ—Å—Ç–∞—Ä—Ç–∏**! üéâ

